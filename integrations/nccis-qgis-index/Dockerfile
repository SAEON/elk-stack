FROM node:17.8.0

ARG ES_ADDRESS
ENV ES_ADDRESS=$ES_ADDRESS

ARG ODP_ADDRESS
ENV ODP_ADDRESS=$ODP_ADDRESS

ARG ODP_CLIENT_ID
ENV ODP_CLIENT_ID=$ODP_CLIENT_ID

ARG ODP_CLIENT_SECRET
ENV ODP_CLIENT_SECRET=$ODP_CLIENT_SECRET

ARG ODP_AUTH_SCOPES
ENV ODP_AUTH_SCOPES=$ODP_AUTH_SCOPES

WORKDIR /app

# Copy code
COPY . .

# Install deps
RUN npm ci --only=production

# Setup the CLI and API executables
ENV PATH="bin:$PATH"
RUN chmod +x bin/exe

# Expose HTTP interface
EXPOSE 3000

CMD \
  ES_ADDRESS=$ES_ADDRESS \
  ODP_ADDRESS=$ODP_ADDRESS \
  ODP_CLIENT_ID=$ODP_CLIENT_ID \
  ODP_CLIENT_SECRET=$ODP_CLIENT_SECRET \
  ODP_AUTH_SCOPES=$ODP_AUTH_SCOPES \
  exe